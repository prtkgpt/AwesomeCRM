// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTH
// ============================================

enum UserRole {
  OWNER          // Company creator, full access
  ADMIN          // Office staff, manage operations
  CLEANER        // Field worker, view assigned jobs
  CUSTOMER       // End customer, view/book services
}

model Company {
  id                  String   @id @default(cuid())
  name                String              // "Acme Cleaning"
  slug                String   @unique    // "acme-cleaning" (for URL)

  // Contact Info
  email               String?
  phone               String?
  address             String?

  // Branding
  logo                String?             // URL to logo
  primaryColor        String?             // Hex color

  // Settings
  timezone            String   @default("America/New_York")
  currency            String   @default("USD")

  // Subscription
  plan                String   @default("FREE")  // FREE, BASIC, PRO
  subscriptionStatus  String   @default("ACTIVE")

  users               User[]
  clients             Client[]
  bookings            Booking[]
  messages            Message[]
  messageTemplates    MessageTemplate[]
  invoices            Invoice[]
  teamMembers         TeamMember[]
  invitations         Invitation[]

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([slug])
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String?
  phone         String?
  businessName  String?

  // Multi-tenancy
  companyId     String
  company       Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  role          UserRole  @default(CUSTOMER)

  // Legacy field - kept for compatibility
  workspaceId   String?

  // Relations
  clients       Client[]
  bookings      Booking[]
  messages      Message[]
  messageTemplates MessageTemplate[]
  invoices      Invoice[]

  // Cleaner profile (if role = CLEANER)
  teamMember    TeamMember?

  // Customer profile (if role = CUSTOMER)
  customerClient  Client?   @relation("CustomerAccount")
  customerBookings Booking[] @relation("CustomerBookings")

  // Invitations sent
  sentInvitations Invitation[] @relation("InvitationSender")

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
  @@index([companyId, role])
}

model TeamMember {
  id                String    @id @default(cuid())
  companyId         String
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  userId            String    @unique
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Employment Info
  hourlyRate        Float?
  employeeId        String?           // Internal ID
  hireDate          DateTime?

  // Personal Info
  emergencyContact  String?
  emergencyPhone    String?
  photo             String?           // Profile photo URL

  // Work Info
  specialties       String[]          // ["Deep Clean", "Move-out"]
  availability      Json?             // Weekly schedule

  // Assignment
  assignedBookings  Booking[]         @relation("AssignedCleaner")

  isActive          Boolean   @default(true)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([companyId])
  @@index([userId])
}

model Invitation {
  id            String      @id @default(cuid())
  companyId     String
  company       Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)

  email         String
  role          UserRole
  token         String      @unique

  invitedById   String
  invitedBy     User        @relation("InvitationSender", fields: [invitedById], references: [id])

  status        String      @default("PENDING")  // PENDING, ACCEPTED, EXPIRED
  expiresAt     DateTime

  createdAt     DateTime    @default(now())

  @@index([token])
  @@index([companyId, email])
}

// ============================================
// CLIENTS & ADDRESSES
// ============================================

model Client {
  id                String    @id @default(cuid())

  // Multi-tenancy
  companyId         String
  company           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Created by (admin/office staff)
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  name              String
  email             String?
  phone             String?
  tags              String[]  // ["VIP", "Weekly", "Monthly", "Pain"]
  notes             String?   // General client notes

  addresses         Address[]
  bookings          Booking[]
  invoices          Invoice[]

  // Stripe integration
  stripeCustomerId  String?   @unique

  // Link to customer user account (if they sign up)
  customerUserId    String?   @unique
  customerUser      User?     @relation("CustomerAccount", fields: [customerUserId], references: [id])

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([companyId])
  @@index([userId])
  @@index([email])
}

model Address {
  id            String    @id @default(cuid())
  clientId      String
  client        Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  label         String?   // "Home", "Office", etc.
  street        String
  city          String
  state         String
  zip           String

  // Cleaner-specific notes
  parkingInfo   String?
  gateCode      String?
  petInfo       String?
  preferences   String?   // "Remove shoes", "Back door", etc.

  bookings      Booking[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([clientId])
}

// ============================================
// BOOKINGS (JOBS)
// ============================================

enum BookingStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum ServiceType {
  STANDARD
  DEEP
  MOVE_OUT
}

enum RecurrenceFrequency {
  NONE
  WEEKLY
  BIWEEKLY
  MONTHLY
}

model Booking {
  id                    String              @id @default(cuid())

  // Multi-tenancy
  companyId             String
  company               Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Created by (admin/office staff)
  userId                String
  user                  User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  clientId              String
  client                Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)

  addressId             String
  address               Address             @relation(fields: [addressId], references: [id])

  // Cleaner Assignment
  assignedTo            String?
  assignee              TeamMember?         @relation("AssignedCleaner", fields: [assignedTo], references: [id])

  // Customer Link (if customer has account)
  customerId            String?
  customer              User?               @relation("CustomerBookings", fields: [customerId], references: [id])

  // Scheduling
  scheduledDate         DateTime
  duration              Int                 // minutes

  // Service details
  serviceType           ServiceType         @default(STANDARD)
  status                BookingStatus       @default(SCHEDULED)

  // Pricing
  price                 Float
  isPaid                Boolean             @default(false)
  paymentMethod         String?             // "card", "cash", "check", "zelle"
  paidAt                DateTime?

  // Stripe integration
  stripePaymentIntentId String?             @unique
  stripePaymentLink     String?

  // Recurrence
  isRecurring           Boolean             @default(false)
  recurrenceFrequency   RecurrenceFrequency @default(NONE)
  recurrenceParentId    String?             // Points to the original booking
  recurrenceEndDate     DateTime?           // When to stop generating

  // Notes
  notes                 String?             // Customer-facing notes
  internalNotes         String?             // Private notes

  // Automation tracking
  confirmationSent      Boolean             @default(false)
  reminderSent          Boolean             @default(false)

  // Estimate (for sharing with potential customers)
  estimateToken         String?             @unique
  estimateAccepted      Boolean             @default(false)
  estimateAcceptedAt    DateTime?

  messages              Message[]
  invoice               Invoice?

  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@index([companyId])
  @@index([userId, scheduledDate])
  @@index([clientId])
  @@index([assignedTo])
  @@index([customerId])
  @@index([status])
  @@index([estimateToken])
  @@index([scheduledDate])
}

// ============================================
// MESSAGING
// ============================================

enum MessageStatus {
  SENT
  DELIVERED
  FAILED
  PENDING
}

enum MessageType {
  CONFIRMATION
  REMINDER
  ON_MY_WAY
  THANK_YOU
  PAYMENT_REQUEST
  CUSTOM
}

model Message {
  id            String        @id @default(cuid())

  // Multi-tenancy
  companyId     String
  company       Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)

  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  bookingId     String?
  booking       Booking?      @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  to            String        // Phone number
  from          String        // Twilio number
  body          String

  type          MessageType   @default(CUSTOM)
  status        MessageStatus @default(PENDING)

  // Twilio metadata
  twilioSid     String?       @unique
  errorMessage  String?

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([companyId])
  @@index([userId])
  @@index([bookingId])
  @@index([twilioSid])
}

model MessageTemplate {
  id            String      @id @default(cuid())

  // Multi-tenancy
  companyId     String
  company       Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)

  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  type          MessageType
  name          String
  template      String      // Template with variables: {{clientName}}, {{date}}, {{time}}, {{price}}

  isActive      Boolean     @default(true)

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([companyId, type])
  @@index([companyId])
  @@index([userId, type])
}

// ============================================
// INVOICES
// ============================================

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

model Invoice {
  id              String        @id @default(cuid())

  // Multi-tenancy
  companyId       String
  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)

  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  clientId        String
  client          Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)

  bookingId       String?       @unique
  booking         Booking?      @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  // Invoice details
  invoiceNumber   String        @unique
  issueDate       DateTime      @default(now())
  dueDate         DateTime
  status          InvoiceStatus @default(DRAFT)

  // Line items stored as JSON
  // Format: [{ description: string, quantity: number, rate: number, amount: number }]
  lineItems       Json

  // Totals
  subtotal        Float
  tax             Float         @default(0)
  total           Float

  // Notes
  notes           String?
  terms           String?       // Payment terms

  // Email tracking
  sentAt          DateTime?
  sentTo          String?       // Email address

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([companyId])
  @@index([userId])
  @@index([clientId])
  @@index([status])
  @@index([invoiceNumber])
}
